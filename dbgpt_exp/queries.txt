SELECT
    c.id AS customer_id,
    (SELECT c2.firstname || ' ' || c2.lastname
     FROM customer c2
     WHERE c2.id = c.id) AS full_name,
    (
      SELECT SUM(o.total::numeric)
      FROM "order" o
      WHERE o.customer = c.id
        AND date_trunc('year', o.ordertimestamp) = (
            SELECT date_trunc('year', MIN(ordertimestamp)) FROM "order"
        )
    ) AS total_spent_last_year
FROM customer c
WHERE c.email IS NOT NULL    -- substitui o filtro impossível
ORDER BY
    (SELECT SUM(o2.total::numeric)
     FROM "order" o2
     WHERE o2.customer = c.id) DESC

SELECT DISTINCT
    a.id AS article_id,
    p.name AS product_name,
    a.originalprice,
    a.reducedprice,
    c.name AS color_name,
    random() AS rnd
FROM articles a
JOIN products p ON p.id = a.productid
JOIN colors c ON c.id = a.colorid
JOIN order_positions op ON op.articleid = a.id
JOIN "order" o ON o.id = op.orderid
WHERE o.ordertimestamp >= (SELECT MIN(ordertimestamp) FROM "order")
  AND p.name IS NOT NULL       -- substitui o filtro impossível
ORDER BY rnd

SELECT
    c.id,
    c.firstname,
    c.lastname,
    c.email
FROM customer c
WHERE c.id IN (
    SELECT DISTINCT o.customer
    FROM "order" o
    JOIN order_positions op ON op.orderid = o.id
    WHERE op.amount >= 1
)

SELECT DISTINCT
    c.id,
    c.firstname,
    c.lastname,
    o.id AS order_id,
    o.ordertimestamp
FROM customer c
LEFT JOIN "order" o ON o.customer = c.id
WHERE o.ordertimestamp >= (SELECT MIN(ordertimestamp) FROM "order")
ORDER BY o.ordertimestamp DESC

SELECT
    c.id,
    c.firstname,
    c.lastname,
    (
        SELECT SUM(o.total::numeric)
        FROM "order" o
        WHERE o.customer = c.id
    ) AS total_spent
FROM customer c
WHERE c.id IN (SELECT customer FROM "order")
ORDER BY total_spent DESC NULLS LAST

SELECT
    p.id AS product_id,
    p.name AS product_name,
    SUM(op.amount * op.price::numeric) AS revenue_period
FROM products p
JOIN articles a ON a.productid = p.id
JOIN order_positions op ON op.articleid = a.id
JOIN "order" o ON o.id = op.orderid
WHERE o.ordertimestamp >= (SELECT MIN(ordertimestamp) FROM "order")
  AND p.currentlyactive = TRUE
GROUP BY p.id, p.name
ORDER BY revenue_period DESC
LIMIT 10

SELECT
    c.id,
    c.firstname,
    c.lastname,
    COUNT(o.id) AS num_orders
FROM customer c
JOIN "order" o ON o.customer = c.id
GROUP BY c.id, c.firstname, c.lastname
HAVING COUNT(o.id) >= 5
ORDER BY num_orders DESC
LIMIT 50

SELECT
    o.id AS order_id,
    o.ordertimestamp,
    c.id AS customer_id,
    c.firstname,
    c.lastname,
    o.total,
    o.shippingcost
FROM "order" o
JOIN customer c ON c.id = o.customer
WHERE o.ordertimestamp >= (SELECT MIN(ordertimestamp) FROM "order")
ORDER BY o.ordertimestamp DESC
LIMIT 500

SELECT
    p.category,
    p.id AS product_id,
    p.name AS product_name,
    SUM(op.amount) AS total_qty
FROM products p
JOIN articles a ON a.productid = p.id
JOIN order_positions op ON op.articleid = a.id
JOIN "order" o ON o.id = op.orderid
WHERE o.ordertimestamp >= (SELECT MIN(ordertimestamp) FROM "order")
GROUP BY p.category, p.id, p.name
ORDER BY p.category, total_qty DESC

SELECT
    c.id,
    c.firstname,
    c.lastname,
    MAX(o.ordertimestamp) AS last_order_timestamp
FROM customer c
LEFT JOIN "order" o ON o.customer = c.id
GROUP BY c.id, c.firstname, c.lastname
HAVING MAX(o.ordertimestamp) < current_date - interval '6 months'
    OR MAX(o.ordertimestamp) IS NULL
ORDER BY last_order_timestamp NULLS FIRST
LIMIT 200

SELECT
    c.id,
    c.firstname,
    c.lastname,
    COUNT(o.id) AS num_orders,
    SUM(o.total::numeric) AS total_spent,
    AVG(o.total::numeric) AS avg_order_value
FROM customer c
JOIN "order" o ON o.customer = c.id
GROUP BY c.id, c.firstname, c.lastname
HAVING COUNT(o.id) >= 3
ORDER BY avg_order_value DESC
LIMIT 20;

SELECT
    p.id AS product_id,
    p.name AS product_name,
    COALESCE(SUM(s.count), 0) AS total_stock,
    COALESCE(SUM(op.amount), 0) AS total_sold
FROM products p
JOIN articles a ON a.productid = p.id
LEFT JOIN stock s ON s.articleid = a.id
LEFT JOIN order_positions op ON op.articleid = a.id
GROUP BY p.id, p.name
HAVING COALESCE(SUM(s.count), 0) < 10   -- “baixo” estoque
ORDER BY total_stock ASC, total_sold DESC;

SELECT
    date_trunc('month', o.ordertimestamp) AS month,
    p.category,
    SUM(op.amount * op.price::numeric) AS revenue
FROM "order" o
JOIN order_positions op ON op.orderid = o.id
JOIN articles a ON a.id = op.articleid
JOIN products p ON p.id = a.productid
GROUP BY month, p.category
ORDER BY month, revenue DESC;

SELECT
    c.id,
    c.firstname,
    c.lastname,
    COUNT(DISTINCT p.category) AS categories_bought
FROM customer c
JOIN "order" o ON o.customer = c.id
JOIN order_positions op ON op.orderid = o.id
JOIN articles a ON a.id = op.articleid
JOIN products p ON p.id = a.productid
GROUP BY c.id, c.firstname, c.lastname
HAVING COUNT(DISTINCT p.category) >= 3
ORDER BY categories_bought DESC, c.id;

WITH bounds AS (
    SELECT (SELECT MAX(ordertimestamp) FROM "order") AS max_ts
)
SELECT
    a.id AS article_id,
    a.description,
    p.name AS product_name,
    COALESCE(SUM(s.count), 0) AS current_stock,
    COUNT(DISTINCT o.id) AS num_orders_recent
FROM articles a
JOIN products p ON p.id = a.productid
LEFT JOIN stock s ON s.articleid = a.id
JOIN order_positions op ON op.articleid = a.id
JOIN "order" o ON o.id = op.orderid
CROSS JOIN bounds b
WHERE o.ordertimestamp >= b.max_ts - interval '1 year'
GROUP BY a.id, a.description, p.name
HAVING COALESCE(SUM(s.count), 0) = 0
ORDER BY num_orders_recent DESC;

SELECT
    p.id,
    p.name
FROM products p
WHERE p.id NOT IN (
    SELECT DISTINCT a.productid
    FROM articles a
    JOIN order_positions op ON op.articleid = a.id
);

SELECT
    p.id,
    p.name,
    p.category,
    a.reducedprice,
    (
        SELECT AVG(a2.reducedprice::numeric)
        FROM articles a2
        JOIN products p2 ON p2.id = a2.productid
        WHERE p2.category = p.category
    ) AS avg_category_price
FROM products p
JOIN articles a ON a.productid = p.id
WHERE a.reducedprice::numeric > (
    SELECT AVG(a3.reducedprice::numeric)
    FROM articles a3
    JOIN products p3 ON p3.id = a3.productid
    WHERE p3.category = p.category
)
LIMIT 50;

SELECT 
    c.id, 
    c.firstname, 
    c.lastname
FROM customer c
ORDER BY (
    SELECT SUM(o.total::numeric) 
    FROM "order" o 
    WHERE o.customer = c.id
) DESC 
LIMIT 50;

SELECT 
    c.id,
    c.firstname,
    (SELECT COUNT(*) FROM "order" o WHERE o.customer = c.id) AS total_orders
FROM customer c
WHERE c.id < 1000;

SELECT 
    o.id,
    o.ordertimestamp,
    o.total
FROM "order" o
WHERE EXTRACT(MONTH FROM o.ordertimestamp) = 12
  AND o.total::numeric > 50;

SELECT
    p.id AS product_id,
    p.name AS product_name,
    COALESCE(SUM(s.count), 0) AS total_stock
FROM products p
LEFT JOIN articles a ON a.productid = p.id
LEFT JOIN stock s ON s.articleid = a.id
GROUP BY p.id, p.name
ORDER BY total_stock DESC;

SELECT
    c.id,
    c.firstname,
    c.lastname,
    c.email,
    c.created
FROM customer c
WHERE c.created >= CURRENT_DATE - INTERVAL '30 days'
ORDER BY c.created DESC;

SELECT
    p.id AS product_id,
    p.name AS product_name,
    SUM(op.amount) AS total_sold
FROM products p
JOIN articles a ON a.productid = p.id
JOIN order_positions op ON op.articleid = a.id
GROUP BY p.id, p.name
ORDER BY total_sold DESC
LIMIT 20;

SELECT
    c.id,
    c.firstname,
    c.lastname,
    COUNT(DISTINCT p.category) AS categories_bought
FROM customer c
JOIN "order" o ON o.customer = c.id
JOIN order_positions op ON op.orderid = o.id
JOIN articles a ON a.id = op.articleid
JOIN products p ON p.id = a.productid
WHERE o.ordertimestamp >= CURRENT_DATE - INTERVAL '6 months'
GROUP BY c.id, c.firstname, c.lastname
HAVING COUNT(DISTINCT p.category) >= 4
ORDER BY categories_bought DESC;

WITH stats AS (
    SELECT
        a.id AS article_id,
        a.description,
        SUM(op.amount) AS total_sold,
        COALESCE(SUM(s.count), 0) AS current_stock
    FROM articles a
    LEFT JOIN stock s ON s.articleid = a.id
    JOIN order_positions op ON op.articleid = a.id
    GROUP BY a.id, a.description
)
SELECT
    article_id,
    description,
    total_sold,
    current_stock,
    (total_sold * 1.0 / NULLIF(current_stock, 0)) AS demand_index
FROM stats
ORDER BY demand_index DESC NULLS LAST
LIMIT 10;

